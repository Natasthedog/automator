{% extends "base.html" %}

{% block title %}Product Description{% endblock %}

{% block content %}
<div class="card">
    <h1>Product Description</h1>
    <p>
        Roll Up levels depend on how the Product Description data is set up, so please
        confirm the Product Description sheet structure before configuring roll-up mappings.
    </p>

    {% if error %}
        <p class="helper-text" style="color:#b91c1c;">{{ error }}</p>
    {% endif %}
    {% if warning %}
        <p class="helper-text" style="color:#92400e;">{{ warning }}</p>
    {% endif %}
    {% if message %}
        <p class="helper-text" style="color:#166534;">{{ message }}</p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="form-grid" id="product-description-form">
        {% csrf_token %}
        <div>
            <label for="scope_workbook">Scope workbook</label>
            <input id="scope_workbook" type="file" name="scope_workbook" accept=".xlsx,.xlsb" />
            <p class="helper-text">Upload (or re-upload) your workbook to inspect Product List roll-up options and build PRODUCT_DESCRIPTION.</p>
        </div>

        {% if sheet_names %}
            <div>
                <label for="product_list_sheet">Product List sheet</label>
                <select id="product_list_sheet" name="product_list_sheet">
                    <option value="">-- Select sheet --</option>
                    {% for sheet_name in sheet_names %}
                        <option value="{{ sheet_name }}" {% if selected_sheet == sheet_name %}selected{% endif %}>{{ sheet_name }}</option>
                    {% endfor %}
                </select>
                <p class="helper-text">If auto-detection misses the Product List, pick the correct sheet manually.</p>
            </div>
        {% endif %}


        {% if sheet_names %}
            <div>
                <label for="ppg_correspondence_sheet">PPG_EAN_CORRESPONDENCE sheet</label>
                <select id="ppg_correspondence_sheet" name="ppg_correspondence_sheet">
                    <option value="">-- Select sheet --</option>
                    {% for sheet_name in sheet_names %}
                        <option value="{{ sheet_name }}" {% if selected_ppg_sheet == sheet_name %}selected{% endif %}>{{ sheet_name }}</option>
                    {% endfor %}
                </select>
                <p class="helper-text">If auto-detection misses PPG_EAN_CORRESPONDENCE, pick it manually.</p>
            </div>
        {% endif %}



        {% if product_list_columns and ppg_sheet_columns %}
            <div>
                <label for="product_list_mapping_column">Product List mapping column</label>
                <select id="product_list_mapping_column" name="product_list_mapping_column">
                    <option value="">-- Try auto (EAN) --</option>
                    {% for column in product_list_columns %}
                        <option value="{{ column }}" {% if selected_product_list_mapping_column == column %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
                <p class="helper-text">Used to map Product List rows to PPG_EAN_CORRESPONDENCE (defaults to EAN).</p>
            </div>
            <div>
                <label for="ppg_mapping_column">PPG_EAN_CORRESPONDENCE mapping column</label>
                <select id="ppg_mapping_column" name="ppg_mapping_column">
                    <option value="">-- Try auto (EAN) --</option>
                    {% for column in ppg_sheet_columns %}
                        <option value="{{ column }}" {% if selected_ppg_mapping_column == column %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
                <p class="helper-text">Used to map PPG rows to Product List (defaults to EAN).</p>
            </div>
            <div>
                <label for="ppg_id_column">PPG_ID column</label>
                <select id="ppg_id_column" name="ppg_id_column">
                    <option value="">-- Try auto (PPG_ID) --</option>
                    {% for column in ppg_sheet_columns %}
                        <option value="{{ column }}" {% if selected_ppg_id_column == column %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
                <p class="helper-text">Used as the first key column in PRODUCT_DESCRIPTION.</p>
            </div>
            <div>
                <label for="ppg_name_column">PPG_NAME column</label>
                <select id="ppg_name_column" name="ppg_name_column">
                    <option value="">-- Try auto (PPG_NAME) --</option>
                    {% for column in ppg_sheet_columns %}
                        <option value="{{ column }}" {% if selected_ppg_name_column == column %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
                <p class="helper-text">Used as the second key column in PRODUCT_DESCRIPTION.</p>
            </div>
        {% endif %}
        {% if product_list_columns %}
            <div>
                <label>Build roll ups</label>
                <p class="helper-text">
                    Choose up to three Product List columns per row. Selected columns are merged with
                    underscores (for example: Brand_Subbrand_Flavour). Use the dropdowns to choose column 1,
                    choose column 2, and choose column 3.
                </p>

                <div id="rollup-builder"></div>
                <button type="button" id="add-rollup-row">Add another roll up</button>

                <div id="rollup-values" style="margin-top:1rem;"></div>

                {% if selected_rollup_pairs %}
                    <p class="helper-text" style="margin-top:1rem;">Saved roll ups:</p>
                    <ul>
                        {% for pair in selected_rollup_pairs %}
                            <li>{{ pair.value }} â†’ {{ pair.alias }}{% if pair.use_multi_label %} (multiple values => Multi {{ pair.alias|lower|title }}){% endif %}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        {% endif %}

        <div>
            <button type="submit" name="action" value="save_rollups">Load / Save Roll Ups</button>
            <button type="submit" name="action" value="generate_scope" style="margin-left:0.5rem;">Generate PRODUCT_DESCRIPTION & Download Scope</button>
        </div>
    </form>
</div>

{% if product_list_columns %}
    {{ product_list_columns|json_script:"product-list-columns" }}
    {{ selected_rollups|json_script:"selected-rollups" }}
    {{ selected_rollup_aliases|json_script:"selected-rollup-aliases" }}
    {{ selected_rollup_parts|json_script:"selected-rollup-parts" }}
    {{ selected_rollup_multi_labels|json_script:"selected-rollup-multi-labels" }}
    <script>
        (function () {
            const columns = JSON.parse(document.getElementById("product-list-columns").textContent);
            const selectedRollups = JSON.parse(document.getElementById("selected-rollups").textContent || "[]");
            const selectedRollupAliases = JSON.parse(document.getElementById("selected-rollup-aliases").textContent || "{}");
            const selectedRollupParts = JSON.parse(document.getElementById("selected-rollup-parts").textContent || "{}");
            const selectedRollupMultiLabels = JSON.parse(document.getElementById("selected-rollup-multi-labels").textContent || "{}");
            const builder = document.getElementById("rollup-builder");
            const addRowButton = document.getElementById("add-rollup-row");
            const rollupValues = document.getElementById("rollup-values");
            const form = document.getElementById("product-description-form");

            function toTitleCase(value) {
                return String(value || "")
                    .replace(/_/g, " ")
                    .split(/\s+/)
                    .filter(Boolean)
                    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(" ");
            }

            function buildSelect(selectedValue, index) {
                const select = document.createElement("select");
                const blank = document.createElement("option");
                blank.value = "";
                blank.textContent = `-- choose column ${index + 1} --`;
                select.appendChild(blank);
                columns.forEach((column) => {
                    const option = document.createElement("option");
                    option.value = column;
                    option.textContent = column;
                    if (selectedValue === column) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                select.setAttribute("aria-label", `Roll-up column ${index + 1}`);
                select.name = `rollup_part_${index + 1}`;
                return select;
            }

            function updateHiddenInputs() {
                rollupValues.innerHTML = "";
                const rows = builder.querySelectorAll("[data-rollup-row]");
                rows.forEach((row) => {
                    const parts = Array.from(row.querySelectorAll("select"))
                        .map((select) => select.value)
                        .filter(Boolean);
                    if (!parts.length) {
                        return;
                    }

                    const rollup = parts.map((part) => String(part || "").trim().replace(/\s+/g, "_")).join("_");
                    const aliasInput = row.querySelector("input[data-alias-input]");
                    const aliasValue = (aliasInput ? aliasInput.value : "").trim() || rollup;
                    const multiCheckbox = row.querySelector("input[data-multi-label-checkbox]");
                    const useMultiLabel = !!(multiCheckbox && multiCheckbox.checked);

                    const chip = document.createElement("p");
                    chip.className = "helper-text";
                    chip.textContent = useMultiLabel
                        ? `Will save: ${rollup} as ${aliasValue} (multiple values => Multi ${toTitleCase(aliasValue)})`
                        : `Will save: ${rollup} as ${aliasValue}`;
                    rollupValues.appendChild(chip);

                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = "rollups";
                    input.value = rollup;
                    rollupValues.appendChild(input);

                    const aliasHidden = document.createElement("input");
                    aliasHidden.type = "hidden";
                    aliasHidden.name = "rollup_aliases";
                    aliasHidden.value = aliasValue;
                    rollupValues.appendChild(aliasHidden);

                    const multiHidden = document.createElement("input");
                    multiHidden.type = "hidden";
                    multiHidden.name = "rollup_use_multi_label";
                    multiHidden.value = useMultiLabel ? "1" : "0";
                    rollupValues.appendChild(multiHidden);
                });
            }

            function addRow(initialParts, initialAlias, initialUseMultiLabel) {
                const row = document.createElement("div");
                row.setAttribute("data-rollup-row", "1");
                row.style.display = "grid";
                row.style.gridTemplateColumns = "repeat(3, minmax(0, 1fr)) minmax(0, 1fr) auto auto";
                row.style.gap = "0.5rem";
                row.style.marginTop = "0.5rem";

                for (let i = 0; i < 3; i += 1) {
                    const select = buildSelect(initialParts && initialParts[i] ? initialParts[i] : "", i);
                    select.addEventListener("change", updateHiddenInputs);
                    row.appendChild(select);
                }

                const aliasInput = document.createElement("input");
                aliasInput.type = "text";
                aliasInput.name = "rollup_alias";
                aliasInput.placeholder = "Rename roll up";
                aliasInput.setAttribute("data-alias-input", "1");
                aliasInput.value = initialAlias || "";
                aliasInput.addEventListener("input", updateHiddenInputs);
                row.appendChild(aliasInput);

                const multiLabelWrap = document.createElement("label");
                multiLabelWrap.style.display = "flex";
                multiLabelWrap.style.alignItems = "center";
                multiLabelWrap.style.gap = "0.25rem";

                const multiLabelCheckbox = document.createElement("input");
                multiLabelCheckbox.type = "checkbox";
                multiLabelCheckbox.setAttribute("data-multi-label-checkbox", "1");
                multiLabelCheckbox.checked = initialUseMultiLabel !== false;
                multiLabelCheckbox.addEventListener("change", updateHiddenInputs);

                const multiLabelText = document.createElement("span");
                multiLabelText.textContent = "Use Multi label";

                multiLabelWrap.appendChild(multiLabelCheckbox);
                multiLabelWrap.appendChild(multiLabelText);
                row.appendChild(multiLabelWrap);

                const removeButton = document.createElement("button");
                removeButton.type = "button";
                removeButton.textContent = "Remove";
                removeButton.addEventListener("click", () => {
                    row.remove();
                    updateHiddenInputs();
                });
                row.appendChild(removeButton);

                builder.appendChild(row);
                updateHiddenInputs();
            }

            if (selectedRollups.length) {
                selectedRollups.forEach((rollup) => {
                    const parts = Array.isArray(selectedRollupParts[rollup])
                        ? selectedRollupParts[rollup].slice(0, 3)
                        : String(rollup || "").split("_").slice(0, 3);
                    addRow(
                        parts,
                        selectedRollupAliases[rollup] || rollup,
                        selectedRollupMultiLabels[rollup] !== false
                    );
                });
            } else {
                addRow([], "", true);
            }

            addRowButton.addEventListener("click", () => addRow([], "", true));
            form.addEventListener("submit", () => {
                updateHiddenInputs();
            });
        })();
    </script>
{% endif %}
{% endblock %}
