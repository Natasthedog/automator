{% extends "base.html" %}

{% block title %}PreQC BPRV{% endblock %}

{% block content %}
<div class="card">
    <h1>PreQC BPRV</h1>
    <p>Upload the scope workbook and the BPRV workbook to evaluate Sales and BPRV relationship quality before the next stage.</p>

    {% if error %}
        <p class="helper-text" style="color:#b91c1c;">{{ error }}</p>
    {% endif %}
    {% if warning %}
        <p class="helper-text" style="color:#92400e;">{{ warning }}</p>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="form-grid">
        {% csrf_token %}
        <div>
            <label for="scope_workbook">Scope workbook</label>
            <input id="scope_workbook" type="file" name="scope_workbook" accept=".xlsx,.xls,.xlsb">
            <p class="helper-text">If Brand is missing in BPRV, this will use the Product Description mapping (PPG -> Brand).</p>
        </div>
        <div>
            <label for="bprv_workbook">BPRV workbook</label>
            <input id="bprv_workbook" type="file" name="bprv_workbook" accept=".xlsx,.xls,.xlsb">
        </div>

        {% if scope_sheet_options %}
        <div>
            <label for="scope_product_description_sheet">Scope Product Description sheet</label>
            <select id="scope_product_description_sheet" name="scope_product_description_sheet">
                <option value="">-- Auto-detect PRODUCT_DESCRIPTION --</option>
                {% for sheet_name in scope_sheet_options %}
                    <option value="{{ sheet_name }}" {% if selected_scope_sheet == sheet_name %}selected{% endif %}>{{ sheet_name }}</option>
                {% endfor %}
            </select>
            <p class="helper-text">If PRODUCT_DESCRIPTION cannot be found automatically, choose it manually.</p>
        </div>
        {% endif %}

        {% if bprv_columns %}
        <div>
            <label for="bprv_ppg_column">BPRV PPG column</label>
            <select id="bprv_ppg_column" name="bprv_ppg_column">
                <option value="">-- Auto-detect --</option>
                {% for column in bprv_columns %}
                    <option value="{{ column }}" {% if selected_bprv_ppg_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="bprv_brand_column">BPRV Brand column (optional override)</label>
            <select id="bprv_brand_column" name="bprv_brand_column">
                <option value="">-- Auto-detect / leave blank to use scope mapping --</option>
                {% for column in bprv_columns %}
                    <option value="{{ column }}" {% if selected_bprv_brand_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
            <p class="helper-text">If BPRV already has Brand, scope Brand lookup is skipped.</p>
        </div>
        <div>
            <label for="bprv_geography_column">BPRV Geography column</label>
            <select id="bprv_geography_column" name="bprv_geography_column">
                <option value="">-- Auto-detect --</option>
                {% for column in bprv_columns %}
                    <option value="{{ column }}" {% if selected_bprv_geography_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="bprv_sales_column">BPRV Sales column</label>
            <select id="bprv_sales_column" name="bprv_sales_column">
                <option value="">-- Auto-detect --</option>
                {% for column in bprv_columns %}
                    <option value="{{ column }}" {% if selected_bprv_sales_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="bprv_value_column">BPRV value column</label>
            <select id="bprv_value_column" name="bprv_value_column">
                <option value="">-- Auto-detect BPRV --</option>
                {% for column in bprv_columns %}
                    <option value="{{ column }}" {% if selected_bprv_value_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        {% if scope_columns %}
        <div>
            <label for="scope_ppg_column">Scope PPG column (used only if BPRV Brand is unavailable)</label>
            <select id="scope_ppg_column" name="scope_ppg_column">
                <option value="">-- Auto-detect --</option>
                {% for column in scope_columns %}
                    <option value="{{ column }}" {% if selected_scope_ppg_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="scope_brand_column">Scope Brand column (used only if BPRV Brand is unavailable)</label>
            <select id="scope_brand_column" name="scope_brand_column">
                <option value="">-- Auto-detect --</option>
                {% for column in scope_columns %}
                    <option value="{{ column }}" {% if selected_scope_brand_column == column %}selected{% endif %}>{{ column }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div>
            <button type="submit">Analyze correlation</button>
        </div>
    </form>

    {% if top_results %}
        <hr style="margin:1.5rem 0;border:none;border-top:1px solid #e5e7eb;">
        <p>{{ correlation_intro }}</p>

        <h2>Top 20 Geography, PPG, Brand combinations by Sales ↔ BPRV correlation</h2>
        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse: collapse; margin-top:0.75rem;">
                <thead>
                    <tr style="background:#f3f4f6;">
                        <th style="text-align:left;padding:0.5rem;border:1px solid #e5e7eb;">Geography</th>
                        <th style="text-align:left;padding:0.5rem;border:1px solid #e5e7eb;">PPG</th>
                        <th style="text-align:left;padding:0.5rem;border:1px solid #e5e7eb;">Brand</th>
                        <th style="text-align:right;padding:0.5rem;border:1px solid #e5e7eb;">Correlation</th>
                        <th style="text-align:right;padding:0.5rem;border:1px solid #e5e7eb;">Total Sales</th>
                        <th style="text-align:right;padding:0.5rem;border:1px solid #e5e7eb;">Rows</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in top_results %}
                        <tr>
                            <td style="padding:0.5rem;border:1px solid #e5e7eb;">{{ row.Geography }}</td>
                            <td style="padding:0.5rem;border:1px solid #e5e7eb;">{{ row.PPG }}</td>
                            <td style="padding:0.5rem;border:1px solid #e5e7eb;">{{ row.Brand }}</td>
                            <td style="padding:0.5rem;border:1px solid #e5e7eb;text-align:right;">{{ row.correlation }}</td>
                            <td style="padding:0.5rem;border:1px solid #e5e7eb;text-align:right;">{{ row.total_sales|floatformat:0 }}</td>
                            <td style="padding:0.5rem;border:1px solid #e5e7eb;text-align:right;">{{ row.n_rows }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h3 style="margin-top:1.25rem;">Visualization</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:0.5rem;">
            {% for row in top_results %}
                <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:0.5rem;">
                    <p style="margin:0;font-size:0.85rem;">{{ row.Geography }} · {{ row.PPG }} · {{ row.Brand }}</p>
                    <div style="height:10px; background:#dbeafe; border-radius:99px; margin-top:0.4rem;">
                        <div style="height:10px; width:{% widthratio row.correlation 1 100 %}%; background:#2563eb; border-radius:99px;"></div>
                    </div>
                    <p style="margin:0.4rem 0 0 0; font-size:0.8rem; color:#1e3a8a;">r = {{ row.correlation }}</p>
                </div>
            {% endfor %}
        </div>

        <form method="get" style="margin-top:1rem;">
            <input type="hidden" name="action" value="download_report">
            <button type="submit">Download full report</button>
        </form>
    {% endif %}
</div>
{% endblock %}
