{% extends "base.html" %}

{% block title %}Deck Automation (MVP){% endblock %}

{% block content %}
<div class="card">
    <h1>Deck Automation (MVP)</h1>
    <p class="helper-text">
        Select one of the built-in templates (MMx, MMM, or PnP), upload gatheredCN10 (required), and optionally upload a scope workbook.
    </p>

    {% if error %}
        <p class="error">{{ error }}</p>
    {% endif %}

    {% if message %}
        <p class="helper-text">{{ message }}</p>
    {% endif %}


    {% if debug_gathered_columns %}
        <div class="summary">
            <h2>Debug details</h2>
            <p>detected gathered header row index: {{ debug_gathered_header_row_index }}</p>
            <p>list(gathered_df.columns): {{ debug_gathered_columns }}</p>
            <p>first 5 payload.categories for the first label: {{ debug_first_payload_categories }}</p>
        </div>
    {% endif %}

    {% if computed_count %}
        <div class="summary">
            <h2>Computed {{ computed_count }} label(s)</h2>
            <ul>
                {% for summary in payload_summaries %}
                    <li>
                        <strong>{{ summary.label }}</strong> â€”
                        {{ summary.category_count }} categories,
                        checksum {{ summary.checksum|floatformat:2 }}
                    </li>
                {% endfor %}
            </ul>
            {% if download_id %}
                <a class="button" href="{% url 'deck-automation-download' download_id %}">
                    Download payloads JSON
                </a>
            {% endif %}
        </div>
    {% endif %}

    <form class="form-grid" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div>
            <label for="template_choice">Deck template</label>
            <select id="template_choice" name="template_choice" required>
                {% for option in template_options %}
                    <option value="{{ option }}" {% if selected_template == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="gathered_cn10">gatheredCN10 upload</label>
            <input id="gathered_cn10" name="gathered_cn10" type="file" accept=".xlsx,.xls,.xlsb,.csv">
        </div>
        <div>
            <label for="scope_workbook">scope workbook upload (optional)</label>
            <input id="scope_workbook" name="scope_workbook" type="file" accept=".xlsx,.xlsb">
        </div>

        <div>
            <label for="year1">Bucket comparison year 1</label>
            <input id="year1" name="year1" type="text" value="{{ year1_value }}" placeholder="Year1">
        </div>
        <div>
            <label for="year2">Bucket comparison year 2</label>
            <input id="year2" name="year2" type="text" value="{{ year2_value }}" placeholder="Year2">
        </div>
        <div>
            <label for="bucket_config_json">Bucket config JSON (optional)</label>
            <textarea id="bucket_config_json" name="bucket_config_json" rows="6" placeholder='{"Price": {"target_labels": ["Own", "Cross"], "subheaders_included": ["Price"]}}'>{{ bucket_config_json }}</textarea>
            <p class="helper-text">Choose which buckets are calculated by listing each bucket key with target labels and gathered columns.</p>
        </div>
        <div>
            <button type="submit">Submit</button>
        </div>
    </form>
</div>
{% endblock %}
